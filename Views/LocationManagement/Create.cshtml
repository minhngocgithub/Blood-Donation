@model Blood_Donation_Website.Models.DTOs.LocationDto
@{
    ViewData["Title"] = "Thêm địa điểm mới";
}

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-danger text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-map-marker-alt me-2"></i>Thêm địa điểm hiến máu mới
                    </h4>
                </div>
                <div class="card-body">
                    <form asp-action="Create" method="post">
                        <div class="mb-3">
                            <label asp-for="LocationName" class="form-label">Tên địa điểm <span class="text-danger">*</span></label>
                            <input asp-for="LocationName" class="form-control" placeholder="Nhập tên địa điểm">
                            <span asp-validation-for="LocationName" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Địa chỉ <span class="text-danger">*</span></label>
                            <div class="row g-2">
                                <div class="col-md-4">
                                    <select id="provinceSelect" class="form-control">
                                        <option value="">Chọn tỉnh/thành phố</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <select id="districtSelect" class="form-control" disabled>
                                        <option value="">Chọn quận/huyện</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <select id="wardSelect" class="form-control" disabled>
                                        <option value="">Chọn phường/xã</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mt-2">
                                <input type="text" id="addressDetail" class="form-control" placeholder="Số nhà, tên đường">
                            </div>
                            <!-- Hidden fields to store names for submission -->
                            <input type="hidden" name="Province" id="province" />
                            <input type="hidden" name="District" id="district" />
                            <input type="hidden" name="Ward" id="ward" />
                            <input type="hidden" name="AddressDetail" id="addressDetailHidden" />
                            <input type="hidden" asp-for="Address" id="fullAddress" />
                            <span asp-validation-for="Address" class="text-danger"></span>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="ContactPhone" class="form-label">Số điện thoại liên hệ</label>
                                <input asp-for="ContactPhone" class="form-control" placeholder="0123456789">
                                <span asp-validation-for="ContactPhone" class="text-danger"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="Capacity" class="form-label">Sức chứa <span class="text-danger">*</span></label>
                                <input asp-for="Capacity" type="number" class="form-control" placeholder="50">
                                <span asp-validation-for="Capacity" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                <input asp-for="IsActive" class="form-check-input" type="checkbox" checked>
                                <label asp-for="IsActive" class="form-check-label">
                                    Kích hoạt địa điểm
                                </label>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between">
                            <a asp-action="Index" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Quay lại
                            </a>
                            <button type="submit" class="btn btn-danger">
                                <i class="fas fa-save me-2"></i>Thêm địa điểm
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const provinceSelect = document.getElementById('provinceSelect');
            const districtSelect = document.getElementById('districtSelect');
            const wardSelect = document.getElementById('wardSelect');
            const addressDetailInput = document.getElementById('addressDetail');
            const fullAddressInput = document.getElementById('fullAddress');
            
            // Hidden fields for form submission
            const provinceHidden = document.getElementById('province');
            const districtHidden = document.getElementById('district');
            const wardHidden = document.getElementById('ward');
            const addressDetailHidden = document.getElementById('addressDetailHidden');

            async function loadProvinces() {
                try {
                    const response = await fetch('https://provinces.open-api.vn/api/p/');
                    const provinces = await response.json();
                    provinces.forEach(province => {
                        // Store code as value, name as text
                        const option = new Option(province.name, province.code);
                        provinceSelect.add(option);
                    });
                } catch (error) {
                    console.error('Error loading provinces:', error);
                }
            }

            async function loadDistricts(provinceCode) {
                try {
                    districtSelect.innerHTML = '<option value="">Chọn quận/huyện</option>';
                    
                    const response = await fetch(`https://provinces.open-api.vn/api/p/${provinceCode}?depth=2`);
                    const provinceData = await response.json();
                    
                    if (provinceData.districts && provinceData.districts.length > 0) {
                        provinceData.districts.forEach(district => {
                            const option = new Option(district.name, district.code);
                            districtSelect.add(option);
                        });
                    }
                } catch (error) {
                    console.error('Error loading districts:', error);
                }
            }

            async function loadWards(districtCode) {
                try {
                    wardSelect.innerHTML = '<option value="">Chọn phường/xã</option>';
                    
                    const response = await fetch(`https://provinces.open-api.vn/api/d/${districtCode}?depth=2`);
                    const districtData = await response.json();
                    
                    if (districtData.wards && districtData.wards.length > 0) {
                        districtData.wards.forEach(ward => {
                            const option = new Option(ward.name, ward.name);
                            wardSelect.add(option);
                        });
                    }
                } catch (error) {
                    console.error('Error loading wards:', error);
                }
            }

            function updateFullAddress() {
                const province = provinceSelect.options[provinceSelect.selectedIndex]?.text || '';
                const district = districtSelect.options[districtSelect.selectedIndex]?.text || '';
                const ward = wardSelect.options[wardSelect.selectedIndex]?.text || '';
                const addressDetail = addressDetailInput.value.trim();
                
                // Update hidden fields with names for form submission
                if (provinceHidden) provinceHidden.value = province && province !== 'Chọn tỉnh/thành phố' ? province : '';
                if (districtHidden) districtHidden.value = district && district !== 'Chọn quận/huyện' ? district : '';
                if (wardHidden) wardHidden.value = ward && ward !== 'Chọn phường/xã' ? ward : '';
                if (addressDetailHidden) addressDetailHidden.value = addressDetail;
                
                const parts = [addressDetail, ward, district, province].filter(part => part && !part.startsWith('Chọn'));
                const fullAddress = parts.join(', ');
                if (fullAddressInput) {
                    fullAddressInput.value = fullAddress;
                }
            }

            provinceSelect.addEventListener('change', async function() {
                districtSelect.innerHTML = '<option value="">Chọn quận/huyện</option>';
                wardSelect.innerHTML = '<option value="">Chọn phường/xã</option>';
                districtSelect.disabled = !this.value;
                wardSelect.disabled = true;
                if (this.value) {
                    await loadDistricts(this.value);
                }
                updateFullAddress();
            });

            districtSelect.addEventListener('change', async function() {
                wardSelect.innerHTML = '<option value="">Chọn phường/xã</option>';
                wardSelect.disabled = !this.value;
                if (this.value) {
                    await loadWards(this.value);
                }
                updateFullAddress();
            });

            wardSelect.addEventListener('change', function() {
                updateFullAddress();
            });

            addressDetailInput.addEventListener('input', function() {
                updateFullAddress();
            });

            loadProvinces();
        });
    </script>
}