@model Blood_Donation_Website.Models.DTOs.DonationRegistrationDto
@using Blood_Donation_Website.Utilities
@{
    ViewData["Title"] = "Theo dõi hiến máu";
}

@section Styles {
    <link rel="stylesheet" href="~/css/donation-progress-page.css" asp-append-version="true" />
}

<div class="donation-progress-page">
    <div class="container">
        <div class="donation-progress-header">
            <h2>
                <i class="fas fa-clock me-2"></i>Theo dõi hiến máu
            </h2>
            <div class="subtitle">Đang trong quá trình hiến máu</div>
        </div>

        @if (TempData["SuccessMessage"] != null)
        {
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fas fa-check-circle me-2"></i>@TempData["SuccessMessage"]
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        }

        @if (TempData["ErrorMessage"] != null)
        {
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-circle me-2"></i>@TempData["ErrorMessage"]
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        }

        <!-- Progress Indicator -->
        <div class="progress-indicator">
            <div class="progress-step completed">
                <div class="step-number">
                    <i class="fas fa-check"></i>
                </div>
                <div class="step-label">Đăng ký</div>
            </div>
            <div class="progress-line completed"></div>
            <div class="progress-step completed">
                <div class="step-number">
                    <i class="fas fa-check"></i>
                </div>
                <div class="step-label">Check-in</div>
            </div>
            <div class="progress-line completed"></div>
            <div class="progress-step completed">
                <div class="step-number">
                    <i class="fas fa-check"></i>
                </div>
                <div class="step-label">Sàng lọc</div>
            </div>
            <div class="progress-line completed"></div>
            <div class="progress-step active">
                <div class="step-number">4</div>
                <div class="step-label">Hiến máu</div>
            </div>
            <div class="progress-line active"></div>
            <div class="progress-step">
                <div class="step-number">5</div>
                <div class="step-label">Hoàn tất</div>
            </div>
        </div>

        <!-- Timer -->
        <div class="progress-timer">
            <div class="timer-display" id="timer">00:00:00</div>
            <div class="timer-label">Thời gian hiến máu</div>
        </div>

        <!-- Thông tin người hiến máu -->
        <div class="user-info-card">
            <div class="user-avatar">
                @(Model.FullName?.Substring(0, 1).ToUpper() ?? "U")
            </div>
            <div class="user-info">
                <h4>@Model.FullName</h4>
                <p><i class="fas fa-id-card me-2"></i>@Model.RegistrationCode</p>
                <p><i class="fas fa-envelope me-2"></i>@Model.UserEmail</p>
                <p><i class="fas fa-phone me-2"></i>@Model.PhoneNumber</p>
            </div>
        </div>

        <!-- Trạng thái hiến máu -->
        <div class="donation-status-card">
            <div class="status-indicator">
                <div class="status-dot"></div>
                <div class="status-text">Đang hiến máu</div>
            </div>
            <p class="text-center mb-0">
                <i class="fas fa-info-circle me-2"></i>
                Quá trình hiến máu đang diễn ra. Vui lòng theo dõi và ghi chú nếu cần thiết.
            </p>
        </div>

        <!-- Thể tích máu -->
        <div class="donation-notes">
            <div class="notes-header">
                <i class="fas fa-tint me-2"></i>Thể tích máu hiến
            </div>
            <div class="blood-volume-container">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <div class="input-group input-group-lg">
                            <span class="input-group-text bg-danger text-white">
                                <i class="fas fa-tint"></i>
                            </span>
                            <input type="number" class="form-control form-control-lg" id="bloodVolume" 
                                   value="350" min="200" max="500" step="50" required 
                                   style="font-size: 1.5rem; font-weight: bold; text-align: center;" />
                            <span class="input-group-text bg-danger text-white" style="font-size: 1.2rem; font-weight: bold;">ml</span>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Giá trị chuẩn: 200ml - 500ml (khuyến nghị: 250ml, 350ml, 450ml)
                            </small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="quick-select-volume">
                            <div class="d-grid gap-2">
                                <button type="button" class="btn btn-outline-danger btn-sm volume-btn" data-volume="250">
                                    <i class="fas fa-tint me-1"></i>250 ml
                                </button>
                                <button type="button" class="btn btn-outline-danger btn-sm volume-btn" data-volume="350">
                                    <i class="fas fa-tint me-1"></i>350 ml
                                </button>
                                <button type="button" class="btn btn-outline-danger btn-sm volume-btn" data-volume="450">
                                    <i class="fas fa-tint me-1"></i>450 ml
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="volume-indicator mt-3">
                    <div class="progress" style="height: 30px;">
                        <div class="progress-bar bg-danger" id="volumeProgress" role="progressbar" 
                             style="width: 50%;" aria-valuenow="350" aria-valuemin="200" aria-valuemax="500">
                            <span id="volumeProgressText" style="font-size: 1rem; font-weight: bold;">350ml / 500ml</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ghi chú -->
        <div class="donation-notes">
            <div class="notes-header">
                <i class="fas fa-sticky-note me-2"></i>Ghi chú trong quá trình hiến máu
            </div>
            <textarea class="notes-textarea" id="donationNotes" placeholder="Ghi chú về quá trình hiến máu (nếu có)..."></textarea>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button type="button" class="btn btn-donation btn-complete" id="completeBtn">
                <i class="fas fa-check me-2"></i>Hoàn tất hiến máu
            </button>
            <button type="button" class="btn btn-donation btn-stop" id="stopBtn">
                <i class="fas fa-stop me-2"></i>Dừng hiến máu
            </button>
            <a asp-action="Index" class="btn btn-donation btn-back">
                <i class="fas fa-arrow-left me-2"></i>Quay lại
            </a>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/sweetalert-helper.js" asp-append-version="true"></script>
    <script>
        $(document).ready(function () {
            var successMsg = '@TempData["SuccessMessage"]';
            var errorMsg = '@TempData["ErrorMessage"]';
            
            if (successMsg) {
                showSuccess('Thành công');
            }
            if (errorMsg) {
                showError('Lỗi');
            }

            // Timer functionality
            var startTime = new Date();
            var timerInterval = setInterval(updateTimer, 1000);

            function updateTimer() {
                var now = new Date();
                var diff = now - startTime;
                
                var hours = Math.floor(diff / (1000 * 60 * 60));
                var minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                var seconds = Math.floor((diff % (1000 * 60)) / 1000);
                
                $('#timer').text(
                    (hours < 10 ? '0' : '') + hours + ':' +
                    (minutes < 10 ? '0' : '') + minutes + ':' +
                    (seconds < 10 ? '0' : '') + seconds
                );
            }

            // Complete donation
            $('#completeBtn').on('click', function() {
                var notes = $('#donationNotes').val();
                var bloodVolume = $('#bloodVolume').val();
                
                // Validate blood volume
                if (!bloodVolume || bloodVolume < 200 || bloodVolume > 500) {
                    showError('Vui lòng nhập thể tích máu hợp lệ (200-500 ml)');
                    return;
                }
                
                showConfirm(
                    'Hoàn tất hiến máu',
                    'Bạn có chắc chắn muốn hoàn tất quá trình hiến máu cho @Model.FullName?',
                    'Hoàn tất',
                    'Hủy bỏ',
                    'success'
                ).then((result) => {
                    if (result.isConfirmed) {
                        // Submit form to complete donation
                        var form = $('<form>', {
                            'method': 'POST',
                            'action': '@Url.Action("Complete", "DonationManagement")'
                        });
                        
                        form.append($('<input>', {
                            'type': 'hidden',
                            'name': 'id',
                            'value': '@Model.RegistrationId'
                        }));
                        
                        form.append($('<input>', {
                            'type': 'hidden',
                            'name': 'notes',
                            'value': notes
                        }));
                        
                        form.append($('<input>', {
                            'type': 'hidden',
                            'name': 'volume',
                            'value': bloodVolume
                        }));
                        
                        form.append($('<input>', {
                            'type': 'hidden',
                            'name': '__RequestVerificationToken',
                            'value': $('input[name="__RequestVerificationToken"]').val()
                        }));
                        
                        $('body').append(form);
                        form.submit();
                    }
                });
            });

            // Quick volume selection buttons
            $('.volume-btn').on('click', function() {
                var volume = $(this).data('volume');
                $('#bloodVolume').val(volume).trigger('input');
                $('.volume-btn').removeClass('active');
                $(this).addClass('active');
            });

            // Update progress bar when volume changes
            $('#bloodVolume').on('input', function() {
                var volume = parseInt($(this).val()) || 200;
                if (volume < 200) volume = 200;
                if (volume > 500) volume = 500;
                
                var percentage = ((volume - 200) / 300) * 100;
                $('#volumeProgress').css('width', percentage + '%');
                $('#volumeProgress').attr('aria-valuenow', volume);
                $('#volumeProgressText').text(volume + 'ml / 500ml');
                
                // Highlight active button if volume matches
                $('.volume-btn').removeClass('active');
                $('.volume-btn[data-volume="' + volume + '"]').addClass('active');
            });

            // Initialize progress bar
            $('#bloodVolume').trigger('input');

            // Stop donation
            $('#stopBtn').on('click', function() {
                var notes = $('#donationNotes').val();
                
                showConfirm(
                    'Dừng hiến máu',
                    'Bạn có chắc chắn muốn dừng quá trình hiến máu cho @Model.FullName?',
                    'Dừng lại',
                    'Hủy bỏ',
                    'warning'
                ).then((result) => {
                    if (result.isConfirmed) {
                        // Submit form to stop donation
                        var form = $('<form>', {
                            'method': 'POST',
                            'action': '@Url.Action("Stop", "DonationManagement")'
                        });
                        
                        form.append($('<input>', {
                            'type': 'hidden',
                            'name': 'id',
                            'value': '@Model.RegistrationId'
                        }));
                        
                        form.append($('<input>', {
                            'type': 'hidden',
                            'name': 'notes',
                            'value': notes
                        }));
                        
                        form.append($('<input>', {
                            'type': 'hidden',
                            'name': '__RequestVerificationToken',
                            'value': $('input[name="__RequestVerificationToken"]').val()
                        }));
                        
                        $('body').append(form);
                        form.submit();
                    }
                });
            });

            // Cleanup on page unload
            $(window).on('beforeunload', function() {
                clearInterval(timerInterval);
            });
        });
    </script>
}